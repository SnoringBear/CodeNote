# 可重入锁

使用Java进行多线程开发，使用锁是一个几乎不可避免的问题。今天，就让我们来聊一聊这个基础，但是又特别特别重要的话题。

首先，让我们来看一下，**到底什么是锁？** 以及，**为什么要使用锁？**

如果有2个线程，需要访问同一个对象User。一个读线程，一个写线程。User对象有2个字段，一个是名字，一个是手机号码。
![Untitled (2).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946132917-381d3cd6-3a07-4ab7-b990-f47d4ebbc377.png#averageHue=%23f0f0ef&clientId=u19e4be48-7c47-4&from=paste&height=1040&id=ubb77ad84&originHeight=1040&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=861333&status=done&style=none&taskId=udb8be298-289a-4458-99da-95c5e0db28b&title=&width=2000)
 当User对象刚刚创建出来的时候，姓名和手机号码都是空。然后，写线程开始填充数据。最后，就出现了以下令人心碎的一幕：  
![Untitled (3).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946159171-a500166c-1b67-4bed-a2a2-f6ebfe10d03e.png#averageHue=%23f9f9f9&clientId=u19e4be48-7c47-4&from=paste&height=1719&id=u5b32bd84&originHeight=1719&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=782066&status=done&style=none&taskId=u5dd81ca4-84df-42c9-9cf5-6b651f28f33&title=&width=2000)
 可以看到，虽然写线程先于读线程工作，但是， 由于写姓名和写电话号码两个操作不是原子的。这就导致读线程只读取了半个数据，在读线程看来，User对象的电话号码是不存在。 为了避免类似的问题，我们就需要使用锁。让写线程在修改对象前，先加锁，然后完成姓名和电话号码的赋值，再释放锁。而读线程也是一样，先取得锁，再读，然后释放锁。这样就可以避免发生这种情况。 如下图所示：  

![Untitled (4).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946182354-62b174e1-8bab-491c-86ea-ce7b325b1983.png#averageHue=%23f8f8f7&clientId=u19e4be48-7c47-4&from=paste&height=2064&id=u946e7599&originHeight=2064&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1451078&status=done&style=none&taskId=u25aefe56-7d1b-44a1-a782-3f431dd8429&title=&width=2000)
![Untitled (5).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946195836-d180ff39-8481-442f-8b77-f41d5024d9da.png#averageHue=%23cdcdcb&clientId=u19e4be48-7c47-4&from=paste&height=1651&id=ubddd6531&originHeight=1651&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1315103&status=done&style=none&taskId=u5c2e0126-217c-4545-859a-99c065af3b5&title=&width=2000)
![Untitled (6).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946230493-9014c4fa-60b8-4f17-815b-b8ebb4cd3045.png#averageHue=%23e2dfde&clientId=u19e4be48-7c47-4&from=paste&height=1472&id=ube5f0120&originHeight=1472&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1278218&status=done&style=none&taskId=u29bc55ba-4dd8-4033-8eb9-5fb7d1675f9&title=&width=2000)
![Untitled (7).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946241588-f721356e-134a-4690-9146-66d45104b83b.png#averageHue=%23f6f6f6&clientId=u19e4be48-7c47-4&from=paste&height=1699&id=u82915ff6&originHeight=1699&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=918326&status=done&style=none&taskId=u98a47b8a-244f-4ffa-849d-094f99c4721&title=&width=2000)
![Untitled (8).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946258681-8b1d78b9-368a-4aa5-b58c-9404373c251a.png#averageHue=%23dedfdf&clientId=u19e4be48-7c47-4&from=paste&height=1422&id=u20369085&originHeight=1422&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=988799&status=done&style=none&taskId=u84f37488-8292-4819-ad71-6f843c38990&title=&width=2000)
![Untitled (9).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946277057-24bffdc5-eaff-4d32-bc34-cf741724b9cb.png#averageHue=%23437b3f&clientId=u19e4be48-7c47-4&from=paste&height=1384&id=u53711ae3&originHeight=1384&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=795404&status=done&style=none&taskId=u67be871c-111b-4cb3-9a5e-163435bfcbb&title=&width=2000)
![Untitled (10).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946297568-006a48be-b9be-47ad-90a5-6b48ce19cff1.png#averageHue=%23ddd7ca&clientId=u19e4be48-7c47-4&from=paste&height=1078&id=u00ae18b3&originHeight=1078&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=664161&status=done&style=none&taskId=u4b6c8b6b-b9e2-45b7-842b-2fa25eb4960&title=&width=2000)
![Untitled (11).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946314886-b9b6d370-087a-462f-a546-2788b7aa56aa.png#averageHue=%238a938b&clientId=u19e4be48-7c47-4&from=paste&height=1631&id=ua727e540&originHeight=1631&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=603240&status=done&style=none&taskId=u28d81ced-8f36-4ae5-a165-ca31ab3644d&title=&width=2000)
![Untitled (12).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946333944-80651f00-3f0c-470b-9411-6ebe152261fb.png#averageHue=%232c2f36&clientId=u19e4be48-7c47-4&from=paste&height=1559&id=u9a05f8fb&originHeight=1559&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=940090&status=done&style=none&taskId=ubedd06e6-84d3-44fd-8497-c1ee7f5d64d&title=&width=2000)

![Untitled (13).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946348254-2267d99d-0fb5-4798-ba5e-b28e7c681db8.png#averageHue=%232b2f36&clientId=u19e4be48-7c47-4&from=paste&height=1577&id=u45155e8c&originHeight=1577&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=750778&status=done&style=none&taskId=u0c4025e5-a532-4b01-87af-c737b19c053&title=&width=2000)
![Untitled (14).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946376067-f7804825-2180-4051-94ce-814a3f1e1f61.png#averageHue=%23cfcfcc&clientId=u19e4be48-7c47-4&from=paste&height=1637&id=u6d258e93&originHeight=1637&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1304609&status=done&style=none&taskId=ue47bfdba-8ee0-4857-b3e1-c82ad180f9d&title=&width=2000)
![Untitled (15).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946388212-3faf007b-b4a2-48af-8930-31c5645597a7.png#averageHue=%232b2e35&clientId=u19e4be48-7c47-4&from=paste&height=1501&id=u158252d4&originHeight=1501&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=699408&status=done&style=none&taskId=u055a948e-c1d2-4621-b889-f41eeeeb058&title=&width=2000)
![Untitled (16).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946402901-407e3414-8983-418f-919b-ae980ee4b17d.png#averageHue=%232b2e35&clientId=u19e4be48-7c47-4&from=paste&height=1627&id=uf5ead5a1&originHeight=1627&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=808765&status=done&style=none&taskId=u28a5e442-93d8-4687-aa82-23bf5bb0923&title=&width=2000)
![Untitled (17).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946418897-d9f74b40-b58c-4c77-954a-4ba622ebf6a4.png#averageHue=%23f9f9f9&clientId=u19e4be48-7c47-4&from=paste&height=1471&id=u74f50832&originHeight=1471&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=866595&status=done&style=none&taskId=u0b669690-d5a0-4bf8-bde6-839cf2dbdec&title=&width=2000)

![Untitled (18).png](https://cdn.nlark.com/yuque/0/2023/png/535904/1690946434355-c359bdc9-b262-4a77-ac41-c69a7ec62e25.png#averageHue=%232a2d34&clientId=u19e4be48-7c47-4&from=paste&height=2066&id=u6ec6cf80&originHeight=2066&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=874032&status=done&style=none&taskId=u23f34c59-3ab4-4049-aa78-a62a093aed8&title=&width=2000)

## **总结**

可重入锁算是多线程的入门级别知识点，所以我把他当做多线程系列的第一章节，对于重入锁，我们需要特别知道几点：

1. 对于同一个线程，重入锁允许你反复获得通一把锁，但是，申请和释放锁的次数必须一致。
2. 默认情况下，重入锁是非公平的，公平的重入锁性能差于非公平锁
3. 重入锁的内部实现是基于CAS操作的。
4. 重入锁的伴生对象Condition提供了await()和singal()的功能，可以用于线程间消息通信。
