# 游戏开发

## 一、同步方式

#### 1、帧同步

帧同步网路游戏：多人对战，房间模式或者比赛模式，Moba(5v5)【王者荣耀】 , FPS【守望先锋】



* **帧同步思路**

  > 客户端操作   ——————> 服务器     ———————> 固定的频率发送采集到的数据给所有客户端，继续采集客户端数据

  * 服务器：

    > |  ————采集————  | ————发送————-|—————-采集————-|

  * 客户端：

    > 收到我们的服务器发过来这一帧的所有玩家的操作，客户端处理这个事件，操作：

    * (1)、服务器每隔多长时间发送一次合适？我们的服务器上‘帧’  1秒多少帧合适？

      ​	对于用户来说，越短越好

      ​	上限：网络传输速度

      ​	下限：与玩家操作手感有关【50ms,100ms】

      ​	启动一个定时器来定时操作【采集数据、发送给所有客户端】

    * (2)、每帧都发送所有玩家的操作，服务器的带宽能否承受？

      ​	分析每次所需要转发数据包的大小来计算





* **TCP与UDP的详解**

  > TCP的核心意涵是什么？面向连接的，可靠的网络传输协议
  >
  > TCP是如何做到可靠的?三次握手【连接】，四次挥手【断开】
  
  * 【传输过程】
  
    ```
    A(空数据包)——————>B,   B————————>A回应一个OK，A收到OK,才会发送下一个数据包
    
    假设网络传输出现问题，A在一定的时间内没有收到B的响应，那么A会重试，直到完整地收到B的回应
    ```
  
  * 可靠是有代价：
  
    * 你发送一个数据包，到发送下一个数据包，等待的时间，至少2倍的传送时间；——>一个数据包，就可以卡住其他数据包的发送
    * 网速的波动，会直接影响后面的数据包的传送，会影响其他数据包的发送；
    * 底层就希望每次发送更多的数据，所有底层‘等’更多的数据一起发送;
    * 粘包问题【数据太少，与其他数据一起发送】、半包问题【数据量太大，分多个包发送】	
  
  * UDP传送：
  
    * 调用底层，掉完以后，你就发送数据，马上又可以发送其他数据了，多个数据包同事在传送
    * UDP缺点：丢包，无法确保先发先到，后发后到【不同通道】
    * 绝大部分情况下UDP还是能正常工作的 ———————→UDP帧同步
  







* **帧同步的20多个流程**

  * 每局比赛，都会有一个比赛管理对象，比赛管理对象【match_mgr】———》帧同步的主要管理对象；

  * 每个比赛对象，都会有一个frameid,表示，本局比赛最新的帧id，每一帧，id+1,|————-|——-|，frameid:从第一帧开始；

  * 每个比赛对象，都会有一个match_frames,数据结构，用来存放游戏从开始到现在经过的所有的帧；

    ```
    【帧1，帧2，帧3，帧4，帧5，帧6，。。。。帧100】
    
    作用：断线重连，录像回看，网络卡住，调试的时候，还有一个作用，UDP缺点，补发，丢掉帧，这个时候，你就需要保存所有的帧
    内存，要多大呢？需要实际计算【每个消息大小*人数*发送次数】
    ```

  * 每个比赛对象，都会有一个数据结构，next_frame_opt,存放采集到的玩家的操作，再一帧的时候，发送客户端【帧ID，{所有玩家的操作}】

  * 每个比赛对象，启动一个定时器，每隔66Ms触发一次，|————-|——-|

  * 将我们这一帧采集到的操作，push到match_frames里面来

  * 遍历比赛里面的每一个玩家，发送“服务器认为”的这个客户端，可能没有同步的帧send_unsync_frames

  * 服务器进入下一帧: self.frameid  =  self.frameid + 1

  * next_frame_opt;清空上一帧的操作，做好存放下一帧操作准备；

  * 每个玩家在服务器上，会有一个玩家对象，玩家对象Player———>sync_frameid,保存了“服务器认为”的客户端已经同步到的帧id;

  * 每一帧的时候，我们的服务器，会从它认为的客户端，没有同步的帧ID开始，到当前最新的帧ID，假设，sync_frameid = 98,100帧【frameid = 100 ,】

  * 通过udp————>发送到前端








* **帧同步用UDP是如何克服缺点**

  ```
  丢包，时序问题
  ```







* **帧同步可能出问题的地方**
  * moba游戏全图挂
  * 棋牌游戏看到玩家的手牌








#### 2、状态同步