# Redis 有序集合底层实现

Redis 的有序集合（Sorted Set）是通过两种数据结构的组合来实现的：**跳表（Skip List）** 和 **哈希表（Hash Table）**。这两种数据结构协同工作，分别为有序性和快速访问提供支持。以下是详细的实现原理：

### 1. **跳表（Skip List）**

#### 跳表的作用：

- 跳表是一种动态数据结构，允许高效的区间查询、排序和范围操作。
- Redis 使用跳表来维护有序集合中元素的顺序。每个元素都有一个分数（score），跳表会根据这个分数对元素进行排序。

#### 跳表的结构：

- 跳表是一种分层的链表结构，由多层链表组成。最底层是一个有序的单链表，每一层链表都跳过若干个节点。这样，在查找时，程序可以从最高层开始，逐层向下，快速跳过不必要的元素，缩短查找路径。
- 在 Redis 中，每个有序集合的元素都会被存储为跳表中的一个节点，这个节点包含了成员的分数和成员值。

#### 跳表操作的时间复杂度：

- 跳表的典型操作（如插入、删除、查找）平均时间复杂度为 O(log⁡N)O(\log N)O(logN)。
- 对于范围查询（如按分数范围或按排名范围查询），跳表的效率也很高，因此非常适合 Redis 有序集合中涉及到的这些操作。

### 2. **哈希表（Hash Table）**

#### 哈希表的作用：

- 哈希表用于通过成员名快速定位该成员的分数。
- Redis 在有序集合中为每个元素同时维护了一个哈希表，以支持 O(1) 时间复杂度的快速查找。

#### 哈希表的结构：

- 这个哈希表的键是有序集合中的成员（element），值是对应的分数（score）。
- 当我们需要通过成员名来获取分数时，可以直接通过哈希表进行 O(1) 查找。

### 3. **跳表和哈希表的结合**

- **跳表** 负责为有序集合提供排序功能，因此有序集合中的操作，如 `ZRANGE`、`ZREVRANGE`、`ZRANGEBYSCORE`、`ZRANK` 等，都是基于跳表的高效范围查询和排序功能来实现的。
- **哈希表** 负责为有序集合提供快速的成员-分数映射，因此操作如 `ZSCORE`（获取成员的分数）、`ZADD`（增加或更新成员及其分数）会用到哈希表来实现快速访问。

### 4. **操作场景与效率**

- **添加操作（ZADD）**: 在 `ZADD` 操作时，Redis 既需要向跳表中插入节点，也需要在哈希表中添加相应的键值对。因为要维持数据在两个结构中的一致性，因此插入操作的时间复杂度为 O(log⁡N)O(\log N)O(logN)，其中 `N` 是有序集合中的元素个数。
- **删除操作（ZREM）**: 删除操作也是类似，Redis 需要同时从跳表和哈希表中删除对应的元素，因此删除操作的时间复杂度同样是 O(log⁡N)O(\log N)O(logN)。
- **范围查询操作**: 诸如 `ZRANGEBYSCORE` 或 `ZRANK` 等操作，Redis 主要通过跳表来完成，它的时间复杂度在平均情况下为 O(log⁡N+M)O(\log N + M)O(logN+M)，其中 `M` 是返回的元素数量。

### 5. **有序集合的实现细节**

- **分数唯一性**：有序集合的分数（score）并不要求唯一，但成员（element）必须唯一。如果两个成员的分数相同，Redis 会按成员的字典顺序（lexicographical order）进行排序。
- **内存优化**：当有序集合中的元素较少时，Redis 使用一种特殊的紧凑存储结构（ziplist，压缩列表）来节省内存。只有当有序集合的元素数量超过一定阈值（默认128个）或单个元素的长度超过阈值（默认64字节）时，Redis 才会切换到跳表和哈希表的实现。

### 6. **示例**

假设有一个有序集合 `zset`，其中存储了多个成员及其分数，Redis 会创建两个数据结构：

- **跳表**：按分数排序，节点包括成员名和分数。
- **哈希表**：键是成员名，值是分数，用于快速定位某个成员的分数。

```
text复制代码跳表:
Layer 3: [   ] -> [   ] -> [   ] -> [   ]
Layer 2: [   ] -> [ A ] -> [   ] -> [ B ]
Layer 1: [ A ] -> [ B ] -> [ C ] -> [ D ]

哈希表:
{
  "A": 5,
  "B": 10,
  "C": 7,
  "D": 8
}
```

在这个例子中，如果需要按分数排序或范围查询，Redis 会使用跳表；如果需要快速查找某个成员的分数，Redis 会使用哈希表。

### 总结

Redis 的有序集合通过跳表和哈希表的结合，既保证了高效的有序访问和范围查询，又提供了 O(1) 的成员查找能力。跳表使得有序集合可以进行高效的排序和范围操作，而哈希表则保证了成员分数的快速访问。这种设计使得 Redis 的有序集合在处理有序数据时非常高效。