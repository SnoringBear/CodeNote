# 网络传输协议

## TCP



## UDP



## KCP

KCP（Kumo Control Protocol）是一种基于UDP协议的快速可靠传输协议。其设计初衷是为了解决在网络拥堵情况下TCP协议网络速度慢的问题，通过牺牲一部分带宽来换取更低的延迟和更高的传输速率。以下是KCP原理的详细解析：

### 一、协议概述

- **目标**：KCP旨在以比TCP浪费10%-20%的带宽为代价，换取平均延迟降低30%-40%，且最大延迟降低三倍的传输效果。
- **实现方式**：纯算法实现，不负责底层协议（如UDP）的收发，需要使用者自己定义下层数据包的发送方式，并以callback的方式提供给KCP。

### 二、核心机制

1. 快速重传和快速恢复
   - KCP使用自己的可靠性控制机制，可以快速探测到丢包并做出相应的重传和恢复操作，减少了网络延迟和丢包对传输效率的影响。
   - 相比TCP的超时重传机制（RTOx2），KCP在快速模式下RTO增长速度为1.5倍，提高了传输速度。
2. 选择性重传
   - TCP在丢包时会全部重传从丢的那个包开始以后的数据，而KCP是选择性重传，只重传真正丢失的数据包。
   - 例如，发送端发送了1,2,3,4,5几个包，然后收到远端的ACK: 1,3,4,5。当收到ACK3时，KCP知道2被跳过1次，收到ACK4时，知道2被跳过了2次，此时可以认为2号丢失，不等超时，直接重传2号包。
3. 数据分片
   - 为了加速传输速度，KCP会将大数据包按照MTU大小分为多个小数据包，并分别进行发送和接收，从而减少传输延迟。
4. FEC纠错
   - KCP引入了前向纠错（Forward Error Correction）技术，通过发送冗余数据包来纠正在传输过程中的丢包等错误，提高数据的可靠性和传输效率。
5. 流量控制和拥塞控制
   - KCP会根据网络的实际情况动态地调整发送窗口大小，以保证数据的可靠传输和避免网络拥塞。
   - 拥塞控制采用慢启动机制，控制拥塞窗口从0开始增长，并根据网络状态调整增长速度。
6. 时间戳和ACK确认
   - KCP发送端会对每个数据包赋予时间戳，接收端回复ACK确认，以确保数据包的可靠传输和防止网络乱序。

### 三、工作模式

KCP有正常模式和快速模式两种：

- **正常模式**：同TCP一样使用公平退让法则，发送窗口大小由发送缓存大小、接收端剩余接收缓存大小、丢包退让及慢启动等要素决定。
- **快速模式**：通过配置跳过后两步（丢包退让及慢启动），仅用发送缓存大小和接收端剩余接收缓存大小来控制发送频率，以牺牲部分公平性及带宽利用率之代价，换取了更高的传输速度。

### 四、总结

KCP通过快速重传、选择性重传、数据分片、FEC纠错、流量控制和拥塞控制等机制，提高了UDP协议的可靠性和传输效率。它适用于对实时性要求较高、但对带宽有一定容忍度的应用场景，如在线游戏、实时音视频传输等